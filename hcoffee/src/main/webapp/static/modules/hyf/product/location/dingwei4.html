<!DOCTYPE HTML>
<html>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
	
	<style type="text/css">
		body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
		#allmap{height:500px;width:100%;}
		#r-result{width:100%; font-size:14px;}
	</style>
	<!--<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html,#allmap {width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
	</style>-->
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=LQZMYslo4klSD1OxU1sdZzmgIskGp1og"></script>
	<script type="text/javascript" src="jsAddress.js"></script>
	<script type="text/javascript" src="mapUtil.js?v=1014"></script>
	<title>html5获取当前城市</title>
	<body>
	<div id="allmap"></div>
	<form style="display:none" id="menu_item1" name="form" method="get" action="">
		<!--<input type="text" name="longitude" id="longitude"/>
		<input type="text" name="latitude" id="latitude"/>-->
		<input type="text" name="ak" id="ak"/>
		<input type="text" name="callback" id="callback"/>
		<input type="text" name="output" id="output"/>
		<input type="text" name="address" id="address"/>
	</form>
		<!--定位输入框：省 、 市 、 区--->
	<div>
省：<select disabled="disabled" id="cmbProvince"></select>
市：<select disabled="disabled" id="cmbCity"></select>
<!--  区： --><select id="cmbArea" style="display:none;"></select>
<button name="dingwei" value="dingwei" onclick="addressToMap();" style="display:none;">地址定位</button>
<button  name="callback_show" id="callback_show" onclick="callbackShow(callback);">回填地址信息</button>
</div>
<!-- 多关键字搜索，默认分割符为空格-->
<div id="keys_search">
		多关键字搜索：<input type="text" name="key" id="key" />		
		<button name="doSearch" id="doSearch" onclick="search();" >搜索</button>
		<button name="clear" id="clear" onclick="doClear();" >清空</button>
		<div id="r-result"></div>
</div>
<div id="auto_complete" style="display:none;">
<!--自动补全--->
请输入:<input type="text" id="suggestId" size="20" value="百度" style="width:150px;" /></div>
<div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
<div>

<div>
<!--<button  name="callback_show" id="callback_show" onclick="callbackShow(callback,'深圳软件产业基地','深圳');">回填地址信息</button>	-->

</div>
<script type="text/javascript">
var province=window.opener.document.getElementById('provinceId').options[window.opener.document.getElementById('provinceId').selectedIndex].text;		
if(province.indexOf("省")>0){
	province=province.substring(0,province.length-1);
}
if(province.indexOf("直辖市")>0){
	province=province.substring(0,province.length-3);
}
var city=window.opener.document.getElementById('cityId').options[window.opener.document.getElementById('cityId').selectedIndex].text;
	addressInit('cmbProvince', 'cmbCity', 'cmbArea', province, city, '');	
</script>
	</body>
</html>	
	<script type="text/javascript">
	var map = new BMap.Map("allmap");	
	window.GlobalVar = {};	
	GlobalVar.map = map;
	GlobalVar.HLPoint = "";
	GlobalVar.currenPoint = "";
	GlobalVar.currenMarker = "";	
	GlobalVar.myAddressPoint = "";
	GlobalVar.txtMenuItem = "";
    GlobalVar.address = "";
    // ---by 20161013
    GlobalVar.searchResult = "";
    GlobalVar.searchResultList = [];//搜索下拉的列表
    GlobalVar.movedMarker = [];//移动过的标注 //---by lizx 20161014 -3
    GlobalVar.indexNumber = 0;
    GlobalVar.City = city;
    prePoi = {};
    first = 0;   
  
//定义快捷菜单
	function initMenuItem(){
			var txtMenuItem = [
			{
				text:'地址回显',
				callback:sendToHL
			},
			{
				text:'显示地址信息',
				callback:showInfo
			},
			{
				text:'删除标记',
				callback:removeMarker
			}
		];
		GlobalVar.txtMenuItem = txtMenuItem;
}

//快捷菜单地址--地址回显
var sendToHL = function(e,ee,marker){
	GlobalVar.currenPoint = marker.point;
//	getAddressInfo(marker,send);
	callbackShow(callback);
}	

//快捷菜单地址--显示地址信息
var showInfo = function(e,ee,marker){
	var geoc = new BMap.Geocoder(); 
	var pt = marker.point;
	GlobalVar.currenPoint = pt;
	geoc.getLocation(pt, function(rs){
		var addComp = rs.addressComponents;
		alert(addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber);
	}); 
}

//快捷菜单地址--删除标记
var removeMarker = function(e,ee,marker){
		map.removeOverlay(marker);
		GlobalVar.currenPoint = "";
}

////获取地址信息
//var getAddressInfo = function(marker,callback){
//	var geoc = new BMap.Geocoder(); 
//	var addr = "";
//	var pt = marker.point;
//	geoc.getLocation(pt, function(rs){
//		var addComp = rs.addressComponents;
//			addr =  addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber;
//			callback(addr);
//	}); 		
//}		
//手机浏览器使用--发送地址		
//	function send(address){	
//		form.action = "http://api.map.baidu.com/geocoder/v2/?";
//		form.address.value = address.replace(",","");
//		form.ak.value = "mHdfy1fLVVzuzMXHwamfqRA14nhuPwlr";
//		form.callback.value = "test";
//		form.output.value = "jsonp";
//		alert("发送给世联"+address);
//		//alert(document.getElementById("longitude").value + "," + document.getElementById("latitude").value + ","+document.getElementById("address").value );
//		form.submit();
//	}
//	function test(result){
//		alert(result);
//	}



//清空多个关键字搜索结果
function doClear(){
	document.getElementById("key").value="";
	document.getElementById("r-result").innerHTML="";
	map.clearOverlays();    //清除地图上所有覆盖物
	//addMarkerLabelAndCenter(GlobalVar.HLPoint,"汇联宜家",14);
	//addDragendMarker(GlobalVar.myAddressPoint,"我的位置",14)
}



//地址回显---触发按钮调用该方法
/**
*<callback>callback</callback> 回调函数
*<address>深圳市卫星大厦<address> 查询地址
*<city>深圳</city> 查询城市
*/
function callbackShow(callback,address,city){
	if(!(GlobalVar.currenPoint || address)){
		alert("请选择目标！");
		return ;
	}
	if(!(address && address.replace(" "))){
		getAddressByPoint(GlobalVar.currenPoint,callback);
	}else{
		if(!city){
				alert("请输入城市名");//如： 深圳
				return ;
		}
		// 创建地址解析器实例
		var myGeo = new BMap.Geocoder();
		// 将地址解析结果显示在地图上,并调整地图视野
		myGeo.getPoint(address, function(point){
			if (point) {
			map.clearOverlays();
			//addMarkerLabelAndCenter(GlobalVar.HLPoint,"汇联宜家",14)
			//addDragendMarker(GlobalVar.myAddressPoint,"我的位置",14)
			GlobalVar.currenPoint = point;
			addDragendMarker(point,"定位结果");
			getAddressByPoint(GlobalVar.currenPoint,callback);
			}else{
				alert("您选择地址没有解析到结果!");
			}
		}, city);
	}
	
}

//地址回显的回调函数，-------------------实现该方法
/**
*<result></result> 传递给回调函数的参数，详情如下
*result.address = resultAddress;  //获取地址
*result.point = GlobalVar.currenPoint; //获取经纬度坐标
*result.longitude = GlobalVar.currenPoint.lng;//获取经度
*result.latitude = GlobalVar.currenPoint.lat; //获取纬度
*/
function callback(result){
	if(result.city != GlobalVar.City ){
		alert(GlobalVar.City+"无此楼盘地址，请重新输入楼盘地址进行搜索");
		return false;
	}	
	//open方式
	window.opener.locationCallBack(result);
	//dialog方式
	//window.returnValue=result;	
	window.close();
	//alert(result.address+","+result.longitude + result.latitude);
}


initMenuItem();//第一步,初始化菜单
init();//第二步，初始化地图
autoComplete("suggestId","searchResultPanel",map);//第三步，初始化自动补全

addressToMap();
var buildingAddress=window.opener.document.getElementById("buildingAddress").value;
if(buildingAddress!=""){
	document.getElementById("key").value=buildingAddress;
	search();	
}

</script>