<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
         符号转义说明
    &lt;          < 	
    &gt;          >  
    &lt;&gt;     <>
    &amp;        & 
    &apos;       '
    &quot;       "
  <![CDATA[ 这里写你的SQL或者符号 ]]> 
 -->
 <!-- 代理商库存管理 -->
<mapper namespace="com.huilian.hlej.hcf.dao.DealerStockManagementDao" > 
	
	<resultMap id="dealerStockListMap" type="com.huilian.hlej.hcf.vo.DealerStockVo">
		<result column="loginName" property="loginName" jdbcType="VARCHAR"/>
		<result column="dealerType" property="dealerType" jdbcType="NUMERIC"/>
		<result column="dealerGrade" property="dealerGrade" jdbcType="NUMERIC"/>
		<result column="conStatus" property="conStatus" jdbcType="NUMERIC"/>
		<result column="cellPhone" property="cellPhone" jdbcType="VARCHAR"/>
		<result column="detailAddress" property="detailAddress" jdbcType="VARCHAR"/>
		<result column="stockAmount" property="stockAmount" jdbcType="NUMERIC"/>
	</resultMap>
	
	<!-- 查询所有代理商 -->
	<select id="getDealerStockVoList" parameterType="com.huilian.hlej.hcf.vo.DealerStockVo" resultMap="dealerStockListMap">
		<![CDATA[
			SELECT 
			  t2.loginName,
			  t2.dealerName,
			  t2.dealerType,
			  t2.dealerGrade,
			  t2.conStatus,
			  t2.cellPhone,
			  t2.detailAddress,
			  SUM(t1.goodsCount) AS stockAmount 
			FROM
			  hcf_dealer_order t1 
			LEFT JOIN hcf_dealer_baseInfo t2 
			ON (t1.userid = t2.id) 
		]]>
		<where>
			1 = 1
			<if test="dealerType != null and dealerType != ''">
				AND t2.dealerType = ${dealerType}
			</if>
			<if test="dealerGrade != null and  dealerGrade != ''">
				AND t2.dealerGrade = ${dealerGrade}
			</if>
			<if test="conStatus != null and  conStatus != ''">
				AND t2.conStatus = ${conStatus}
			</if>
			<if test="searchText != null and  searchText != ''">
				AND
				(t2.loginName = #{searchText} OR t2.dealerName = #{searchText} OR t2.cellPhone = #{searchText})
			</if>
		</where>   
		<![CDATA[
			GROUP BY t1.userid
			ORDER BY t1.createTime DESC
		]]>
	</select>
	
	<select id="getVendCodesByLoginName" parameterType="java.lang.String" resultType="java.lang.String">
		<![CDATA[
			SELECT 
			  GROUP_CONCAT(t2.vendCode) AS vendCodes 
			FROM hcf_dealer_baseInfo t1 
			LEFT JOIN hcf_vend_dealer t2 
			ON (t1.loginName = t2.loginName) 
			WHERE t1.loginName = #{loginName}
		]]>
	</select>
	
	<resultMap id="dealerStockDetailVoListMap" type="com.huilian.hlej.hcf.vo.DealerStockDetailVo">
		<result column="goodsId" property="goodsId" jdbcType="VARCHAR"/>
		<result column="goodsName" property="goodsName" jdbcType="VARCHAR"/>
		<result column="stockCount" property="count" jdbcType="NUMERIC"/>
		<result column="saledAmount" property="saledAmount" jdbcType="NUMERIC"/>
		<result column="procurementAmount" property="procurementAmount" jdbcType="NUMERIC"/>
		<result column="procuAmount" property="procuAmount" jdbcType="NUMERIC"/>
	</resultMap>
	
	<select id="getDealerStockDetailVoList" parameterType="com.huilian.hlej.hcf.vo.DealerStockDetailVo" resultMap="dealerStockDetailVoListMap">
			SELECT 
			  t1.goodsId,
			  t1.goodsName,
			  t2.specification,
			  t2.count,
			  COUNT(1) AS saledAmount,
			  (SELECT COUNT(1) FROM hcf_dealer_order d WHERE d.orderStatus=7 AND d.goodsId = t2.goodsId) AS procuAmount,
			  (SELECT COUNT(1) FROM hcf_dealer_order e WHERE e.orderStatus=7 AND e.goodsId = t2.goodsId) AS procurementAmount
			FROM
			  hcf_vend_order_info t1 
			  LEFT JOIN hcf_goods_details t2 
			    ON (t1.goodsId = t2.goodsId) 
			WHERE vendCode IN (${vendCodes})
			GROUP BY t1.goodsId,
			  t1.goodsName,
			  t2.specification,
			  t2.count 
	</select>
	
	<resultMap id="listMap" type="com.huilian.hlej.hcf.vo.DealerStockVo">
		<result column="loginName" property="loginName" jdbcType="VARCHAR"/>
		<result column="dealerName" property="dealerName" jdbcType="VARCHAR"/>
		<result column="cellPhone" property="cellPhone" jdbcType="VARCHAR"/>
		<result column="machineNum" property="machineNum" jdbcType="NUMERIC"/>
		<result column="vendCodes" property="vendCodes" jdbcType="VARCHAR"/>
	</resultMap>
	
	<select id="loginNameMachineNumVendCodsList" resultMap="listMap">
		<![CDATA[
			SELECT 
			  t1.loginName,
			  t2.dealerName,
			  t2.cellPhone,
			  COUNT(1) AS machineNum,
			  GROUP_CONCAT(t1.vendCode) AS vendCodes 
			FROM
			  hcf_vend_dealer t1 
			  LEFT JOIN hcf_dealer_baseInfo t2 
			    ON (t1.loginName = t2.loginName) 
			GROUP BY loginName
		]]>
	</select>
	
	<resultMap id="listMapOne" type="com.huilian.hlej.hcf.vo.DealerStockVo">
		<result column="loginName" property="loginName" jdbcType="VARCHAR"/>
		<result column="stockAmount" property="stockAmount" jdbcType="NUMERIC"/>
	</resultMap>
	
	<select id="loginNameStockCountList" resultMap="listMapOne">
		<![CDATA[
			SELECT 
			  t2.loginName,
			  SUM(t1.goodsCount) AS stockAmount 
			FROM
			  hcf_dealer_order t1,
			  hcf_dealer_baseInfo t2 
			WHERE t1.userId = t2.id 
			GROUP BY t2.loginName
		]]>
	</select>
	
	<select id="getSaleCountByVendCodes" parameterType="java.lang.String" resultType="java.lang.Integer">
		<![CDATA[
			SELECT 
			  COUNT(goodsId) 
			FROM
			  hcf_vend_order_info
			WHERE vendCode IN (${vendCodes})
		]]>
	</select>
	
</mapper>   
