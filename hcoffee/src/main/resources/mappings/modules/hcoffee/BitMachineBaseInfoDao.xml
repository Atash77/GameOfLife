<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
         符号转义说明
    &lt;          < 	
    &gt;          >  
    &lt;&gt;     <>
    &amp;        & 
    &apos;       '
    &quot;       "
  <![CDATA[ 这里写你的SQL或者符号 ]]> 
 -->
<mapper namespace="com.huilian.hlej.hcf.dao.BitMachineBaseInfoDao" > 

	
	<resultMap id="bitMachineBaseInfoVoMap" type="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		<result column="machine_id" property="id" jdbcType="VARCHAR"/>
		<result column="android_id" property="androidId" jdbcType="VARCHAR"/>
		<result column="machine_code" property="machineCode" jdbcType="VARCHAR"/>
		<result column="machine_name" property="machineName" jdbcType="VARCHAR"/>
		<result column="machine_memo" property="machineMemo" jdbcType="VARCHAR"/>
		<result column="offline_or_online_time" property="offlineOrOnlineTime" jdbcType="VARCHAR"/>
		<result column="is_online" property="isOnline" jdbcType="VARCHAR"/>
		<result column="organization_root_id" property="organizationRootId" jdbcType="VARCHAR"/>
		<result column="organization_id" property="organizationId" jdbcType="VARCHAR"/>
		<result column="used_pay_type" property="usedPayType" jdbcType="VARCHAR"/>
		<result column="is_aisle_break" property="isAisleBreak" jdbcType="VARCHAR"/>
		<result column="gmt_created" property="gmtCreated" jdbcType="VARCHAR"/>
		<result column="gmt_modified" property="gmtModified" jdbcType="VARCHAR"/>
		<result column="isOutOfStock" property="isOutOfStock" jdbcType="VARCHAR"/>
	</resultMap>

	<select id="findBitMachineBaseInfoVoList" resultMap="bitMachineBaseInfoVoMap"
		parameterType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		SELECT
			h.machine_id,
			h.android_id,
			h.machine_code,
			h.machine_name,
			h.machine_memo,
			h.offline_or_online_time,
			h.is_online,
			h.organization_root_id,
			h.organization_id,
			h.used_pay_type,
			h.is_aisle_break,
			h.gmt_created,
			h.gmt_modified,
			CASE
			WHEN sum( CASE WHEN t1.machine_aisle_id is null	THEN 0 ELSE 1 END ) > 0 THEN
			'0' ELSE '1' 
			END  AS isOutOfStock 
		FROM
			machine_base_info AS h LEFT JOIN machine_aisle_info t1 ON h.machine_id = t1.machine_id 
			AND t1.goods_stock = 0 
		WHERE 1=1
		<if test="machineName != null and  machineName != ''">
			AND h.machine_name = #{machineName}
		</if>
		<if test="machineCode != null and  machineCode != ''">
			AND h.machine_code = #{machineCode}
		</if>
		<if test="isOnline != null">
			AND h.is_online = #{isOnline}
		</if>
		<if test="isAisleBreak != null ">
			AND h.is_aisle_break = #{isAisleBreak}
		</if>
		<if test="isOutOfStock != null ">
			AND 
				<if test="isOutOfStock == 1 "> t1.machine_aisle_id is null </if><if test="isOutOfStock == 0 "> t1.goods_stock = 0 </if>
		</if>
		<if test="searchText != null and  searchText != ''">
			AND (h.machine_id like CONCAT('%','${searchText}','%' ) OR h.machine_code like CONCAT('%','${searchText}','%' ))
		</if>
		GROUP BY
			h.machine_id,
			h.android_id,
			h.machine_code,
			h.machine_name,
			h.machine_memo,
			h.offline_or_online_time,
			h.is_online,
			h.organization_root_id,
			h.organization_id,
			h.used_pay_type,
			h.is_aisle_break,
			h.gmt_created,
			h.gmt_modified
		ORDER BY h.is_online ASC,h.offline_or_online_time DESC,isOutOfStock DESC,h.machine_code ASC
	</select>
	
	<update id="updateBitMachineBaseInfoVo" parameterType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		UPDATE `hcf_lotto_vend_prize`
		<set>
			<if test="activityNo!=null and activityNo!=''">
				activityNo = #{activityNo},
			</if>
			<if test="activityName!=null and activityName!=''">
				activityName = #{activityName},
			</if>
			
			<if test="vendCode!=null and vendCode!=''">
				vendCode = #{vendCode},
			</if>
			<if test="prizeName!=null and prizeName!=''">
				prizeName = #{prizeName},
			</if>
			<if test="prizeType!=null and prizeType!=''">
				prizeType = #{prizeType},
			</if>
			<if test="location!=null and location!=''">
				location = #{location},
			</if>
			<if test="shelf!=null and shelf!=''">
				shelf = #{shelf},
			</if>
			<if test="goodsID!=null and goodsID!=''">
				goodsID = #{goodsID},
			</if>
			<if test="prizeUrl!=null and prizeUrl!=''">
				prizeUrl = #{prizeUrl},
			</if>
			<if test="prizeNum!=null and prizeNum!=''">
				prizeNum = #{prizeNum},
			</if>
			<if test="probability!=null and probability!=''">
				probability = #{probability},
			</if>
			<if test="sort!=null and sort!=''">
				sort = #{sort},
			</if>
		</set>
		<where>
				id = ${id}
		</where>
				
	</update>
	
	
	
	
	
	<resultMap id="lottoActivityVoMap" type="com.huilian.hlej.hcf.vo.LottoActivityVo">
		<result column="activityNo" property="activityNo" jdbcType="VARCHAR"/>
		<result column="activityName" property="activityName" jdbcType="VARCHAR"/>
	</resultMap>
	<select id="getLottoActivityVoAll" resultMap="lottoActivityVoMap">
		<![CDATA[
			SELECT
				activityNo,
				activityName
			FROM
				hcf_lotto_activity
		]]>	
	</select>
	
	
	<select id="getPrizeList" parameterType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo" resultType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		<![CDATA[
			SELECT *  FROM hcf_lotto_vend_prize AS t WHERE 1=1 
		]]>
		<if test="vendCode != null and  vendCode != ''">
			AND t.vendCode = #{vendCode}
		</if>
		<if test="activityNo != null and  activityNo != ''">
			AND t.activityNo=#{activityNo}
		</if>
	</select>
	<select id="getBitMachineBaseInfoVo" parameterType="java.lang.String" resultType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		<![CDATA[
			SELECT *  FROM hcf_lotto_vend_prize AS t WHERE 1=1 AND t.id = #{id}
		]]>
	</select>
	<delete id="deletePrize" parameterType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		<![CDATA[
			DELETE from hcf_lotto_vend_prize where id=#{id}
		]]>
	</delete>
	
	<select id="checkPrizeName" parameterType="java.lang.String" resultType="java.lang.Integer">
		<![CDATA[
			SELECT count(1) from hcf_lotto_vend_prize where prizeName = #{prizeName}
		]]>
	</select>
	
	<select id="getBitMachineBaseInfoVoListByActivityNoAndVendCode" parameterType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo" 
		resultType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		<![CDATA[
			SELECT *  FROM hcf_lotto_vend_prize AS t WHERE 1=1 
		]]>
		<if test="vendCode != null and  vendCode != ''">
			AND t.vendCode = #{vendCode}
		</if>
		<if test="activityNo != null and  activityNo != ''">
			AND t.activityNo=#{activityNo}
		</if>
	</select>
	
	<delete id="deleteListByActivityNoAndVendCode" parameterType="com.huilian.hlej.hcf.vo.BitMachineBaseInfoVo">
		<![CDATA[
			DELETE from hcf_lotto_vend_prize where activityNo=#{activityNo} AND vendCode=#{vendCode}
		]]>
	</delete>
</mapper>   
