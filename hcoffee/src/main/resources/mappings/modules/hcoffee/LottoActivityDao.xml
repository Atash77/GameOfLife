<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
         符号转义说明
    &lt;          < 	
    &gt;          >  
    &lt;&gt;     <>
    &amp;        & 
    &apos;       '
    &quot;       "
  <![CDATA[ 这里写你的SQL或者符号 ]]> 
 -->
<mapper namespace="com.huilian.hlej.hcf.dao.LottoActivityDao" > 

	<insert id="saveLottoActivityVo" useGeneratedKeys="true" keyProperty="id">
		<![CDATA[
			INSERT INTO `hcf_lotto_activity` (
			  `activityNo` ,
			  `activityName` ,
			  `createTime` ,
			  `startTime` ,
			  `endTime` ,
			  `lottoWay` ,
			  `triggerCondition` ,
			  `activityDesc` 
			)
			VALUES
				(
					#{activityNo},
					#{activityName},
					#{createTime},
					#{startTime},
					#{endTime},
					#{lottoWay},
					#{triggerCondition},
					#{activityDesc}
				)
			]]> 
	</insert>
	<update id="updateLottoActivityVo" parameterType="com.huilian.hlej.hcf.vo.LottoActivityVo">
		UPDATE `hcf_lotto_activity`
		<set>
			<if test="activityNo!=null and activityNo!=''">
				activityNo = #{activityNo},
			</if>
			<if test="activityName!=null and activityName!=''">
				activityName = #{activityName},
			</if>
			
			<if test="createTime!=null and createTime!=''">
				createTime = #{createTime},
			</if>
			<if test="startTime!=null and startTime!=''">
				startTime = #{startTime},
			</if>
			<if test="endTime!=null and endTime!=''">
				endTime = #{endTime},
			</if>
			<if test="lottoWay!=null and lottoWay!=''">
				lottoWay = #{lottoWay},
			</if>
			<if test="triggerCondition !=null and triggerCondition!=''">
				triggerCondition = #{triggerCondition},
			</if>
			<if test="activityDesc !=null and activityDesc !=''">
				activityDesc = #{activityDesc},
			</if>
		</set>
		<where>
				id = ${id}
		</where>
	</update>
	
	<resultMap id="lottoActivityVoMap" type="com.huilian.hlej.hcf.vo.LottoActivityVo">
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<result column="activityName" property="activityName" jdbcType="VARCHAR"/>
		<result column="activityNo" property="activityNo" jdbcType="VARCHAR"/>
		<result column="createTime" property="createTime" jdbcType="VARCHAR"/>
		<result column="startTime" property="startTime" jdbcType="VARCHAR"/>
		<result column="endTime" property="endTime" jdbcType="VARCHAR"/>
		<result column="nowTime" property="nowTime" jdbcType="VARCHAR"/>
	</resultMap>

	<select id="findLottoActivityVoList" resultMap="lottoActivityVoMap"
		parameterType="com.huilian.hlej.hcf.vo.LottoActivityVo">
		SELECT
			h.id,
			h.activityName,
			h.activityNo,
			h.createTime,
			h.startTime,
			h.endTime,
			NOW() AS nowTime
		FROM
			hcf_lotto_activity AS h  
		where 1=1
		<if test="activityName != null and  activityName != ''">
			AND h.activityName like CONCAT('%','${activityName}','%' )
		</if>
		<if test="lottoWay != null and  lottoWay != ''">
			AND h.lottoWay = ${lottoWay}
		</if>
		<if test="triggerCondition != null and  triggerCondition != ''">
			AND h.triggerCondition = ${triggerCondition}
		</if>
		<if test="activityStatus != null and  activityStatus != ''">
			<choose>     
	            <when test="activityStatus == 1 ">     
	                AND UNIX_TIMESTAMP(NOW()) &lt; UNIX_TIMESTAMP(h.startTime)
	            </when>     
	            <when test="activityStatus == 2  ">     
	                AND UNIX_TIMESTAMP(NOW()) BETWEEN UNIX_TIMESTAMP(h.startTime) AND UNIX_TIMESTAMP(h.endTime)    
	            </when>     
	            <when test="activityStatus == 3 ">     
	                AND UNIX_TIMESTAMP(NOW()) &gt; UNIX_TIMESTAMP(h.endTime)
	            </when>     
	            <otherwise>     
	                    AND 2=2  
	            </otherwise>     
	        </choose>     
		</if>
		ORDER BY h.createTime DESC  
	</select>
	
	<!-- 查询,主键查询   -->
	<select id="getLottoActivityVo" parameterType="java.lang.String"  resultType="com.huilian.hlej.hcf.vo.LottoActivityVo"  >
		SELECT
			h.*
		FROM
			hcf_lotto_activity h  
			WHERE 1=1  AND activityNo=#{activityNo}
	</select>	
	
	
	<resultMap id="lottoEqRelationVoMap" type="com.huilian.hlej.hcf.vo.LottoEqRelationVo">
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<result column="activityNo" property="activityNo" jdbcType="VARCHAR"/>
		<result column="vendCode" property="vendCode" jdbcType="VARCHAR"/>
		<result column="location" property="location" jdbcType="VARCHAR"/>
	</resultMap>
	
	<select id="getLottoEqRelationVoList" resultMap="lottoEqRelationVoMap"
		parameterType="java.lang.String">
		<![CDATA[
			select id,activityNo,vendCode,location from hcf_lotto_vend_prize where activityNo = #{activityNo} group by vendCode
		]]>	
	</select>
	
	<resultMap id="lottoEqRelationVoMap2" type="com.huilian.hlej.hcf.vo.LottoEqRelationVo">
		<result column="vendCode" property="vendCode" jdbcType="VARCHAR"/>
		<result column="location" property="location" jdbcType="VARCHAR"/>
	</resultMap>
	
	<select id="getLottoEqRelationVoAll" resultMap="lottoEqRelationVoMap2">
		<![CDATA[
			SELECT
			vendCode,
			CONCAT(
				provinceName,
				cityName,
				areaName,
				deliveryType,
				location
			) AS location
		FROM
			hsh_vend_qr_code
		]]>	
		<where>
			location &lt;&gt; ''
		</where>
	</select>
	
	
	<select id="queryActivityNameByActivityNo" parameterType="java.lang.String" resultType="java.lang.String">
		<![CDATA[
			SELECT activityName FROM hcf_lotto_activity t WHERE t.activityNo = #{activityNo}
		]]>
	</select>
	
	<select id="getLocationByVendCode" resultType="java.lang.String" parameterType="java.lang.String" >
		<![CDATA[
			SELECT
			CONCAT(
				provinceName,
				cityName,
				areaName,
				deliveryType,
				location
			) AS location
		FROM
			hsh_vend_qr_code
		]]>	
		<where>
			location &lt;&gt; '' 
			AND  
			vendCode = #{vendCode}
		</where>
	</select>
	
	<select id="checkActivityName" parameterType="java.lang.String" resultType="java.lang.Integer">
		<![CDATA[
			SELECT count(1) from hcf_lotto_activity where activityName = #{activityName}
		]]>
	</select>
	
	<select id="checkActivityNo" parameterType="java.lang.String" resultType="java.lang.Integer">
		<![CDATA[
			SELECT count(1) from hcf_lotto_activity where activityNo = #{activityNo}
		]]>
	</select>
	
	<select id="getDrawNum" parameterType="java.lang.String" resultType="java.lang.Integer">
		<![CDATA[
			SELECT IFNULL(SUM(count),0) FROM hcf_lotto_user_info WHERE activityNo = #{activityNo}
		]]>
	</select>
	
	<select id="getWinnerNum" parameterType="java.lang.String" resultType="java.lang.Integer">
		<![CDATA[
			SELECT COUNT(1) FROM hcf_lotto_prize_info WHERE activityNo = #{activityNo}
		]]>
	</select>
	
	
</mapper>   
