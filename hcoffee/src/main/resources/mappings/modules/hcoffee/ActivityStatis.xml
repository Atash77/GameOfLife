<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
         符号转义说明
    &lt;          < 	
    &gt;          >  
    &lt;&gt;     <>
    &amp;        & 
    &apos;       '
    &quot;       "
  <![CDATA[ 这里写你的SQL或者符号 ]]> 
 -->
<mapper namespace="com.huilian.hlej.hcf.dao.ActivityStatisDao" > 

		<select id="selectActivityStatis" resultType="com.huilian.hlej.hcf.vo.ActivityStatisVo" parameterType="com.huilian.hlej.hcf.vo.ActivityStatisVo">
        SELECT
			t.*, hsh_activity_scheme.schemeName,
			hsh_activity_scheme.createTime,
			hsh_activity_scheme. STATUS,
			hsh_channel.channel_name AS channelName
		FROM
			hsh_activity_scheme,
			(
				SELECT
					hsh_vend_reward.channel usrChannel,
					hsh_vend_reward.schemeNo,
					count(*) rewardCnt
				FROM
					hsh_vend_reward
				GROUP BY
					hsh_vend_reward.channel,
					hsh_vend_reward.schemeNo
			) t,
			hsh_channel
			 
        <where>
        	t.schemeNo = hsh_activity_scheme.schemeNo
			AND hsh_channel.channel_id = t.usrChannel 
            <if test="startTime != null and  startTime != ''">
                AND hsh_activity_scheme.createTime    &gt;=  #{startTime}
            </if>
    		<if test="endTime != null and  endTime != ''">
                AND hsh_activity_scheme.createTime    &lt;=  #{endTime}
            </if>
            <if test="usrChannel != null and  usrChannel != ''">
                AND hsh_channel.channel_id   =  #{usrChannel}
            </if>
             <if test="schemeNo != null and  schemeNo != ''">
                AND hsh_activity_scheme.schemeNo   =  #{schemeNo}
            </if>
            <if test="schemeNoList != null and  schemeNoList != ''">
                AND t.schemeNo   in  (${schemeNoList})
            </if>
            <if test="channelList != null and  channelList != ''">
                AND t.usrChannel   in  (${channelList})
            </if>
        </where>
       		    ORDER BY  hsh_activity_scheme.createTime desc
    	</select>
    	
   	<select id="selectActivityVoPage" resultType="com.huilian.hlej.hcf.vo.ActivityManageVo" parameterType="com.huilian.hlej.hcf.vo.ActivityManageVo">
       		     SELECT
				hsh_activity_scheme.*
			FROM
				hsh_activity_scheme
			where 1=1	
			<if test="schemeNo != null and  schemeNo != ''">
                AND hsh_activity_scheme.schemeNo  like  CONCAT('%','${schemeNo}','%' )
            </if>
			<if test="schemeName != null and  schemeName != ''">
                AND hsh_activity_scheme.schemeName  like  CONCAT('%','${schemeName}','%' )
            </if>
			<if test="activityId != null and  activityId != ''">
                AND hsh_activity_scheme.activity_id  like  CONCAT('%','${activityId}','%' )
            </if>
			<if test="activityType != null and  activityType != ''">
                AND hsh_activity_scheme.activityType  like  CONCAT('%','${activityType}','%' )
            </if>
            <if test="startTime != null and  startTime != ''">
                AND hsh_activity_scheme.createTime    &gt;=  #{startTime}
            </if>
    		<if test="endTime != null and  endTime != ''">
                AND hsh_activity_scheme.createTime    &lt;=  #{endTime}
            </if>
			ORDER BY hsh_activity_scheme.createTime DESC
	       
    	</select>
    	
    	
    	 	
		<update id="updateAtivityManagement" >
	       UPDATE `hsh_activity_scheme`
			<set>
				
				<if test="schemeName !=null and schemeName !=''">
					schemeName = #{schemeName},
				</if>
				<if test="status !=null and status !=''">
					status = #{status},
				</if>
				
				updateTime = now()
			</set>
			WHERE schemeNo = #{schemeNo}	
	       
	    </update>
    	
    	<select id="getActivityManagementCode" resultType="com.huilian.hlej.hcf.vo.ActivityManageVo" >
	       SELECT
				hsh_activity_scheme.*
			FROM
				hsh_activity_scheme
			WHERE id = #{id}
    	</select>
    	
    	
    	
	<select id="selectRewardRecordList"  resultType="com.huilian.hlej.hcf.vo.RewardRecordVo" parameterType="com.huilian.hlej.hcf.vo.RewardRecordVo" >
		SELECT
			hsh_vend_reward.goodsId,
			hsh_vend_reward.goodsName,
			hsh_vend_reward.price,
			hsh_vend_reward.drawCode,
			hsh_vend_qr_code.vendcode,
			hsh_vend_qr_code.communityName,
			hsh_vend_reward.createDate,
			hsh_vend_reward.acquireDate,
			hsh_vend_reward.phoneNo,
			hsh_vend_reward.status,
			hsh_vend_reward.id ,
			hsh_vend_reward.schemeNo ,
			hsh_vend_reward.channel,
		    hsh_vend_reward.getVenderId
		FROM
			hsh_vend_reward,
			hsh_vend_qr_code
			
		<where>
        	hsh_vend_qr_code.id = hsh_vend_reward.venderId
            <if test="startTime != null and  startTime != ''">
                AND hsh_vend_reward.acquireDate    &gt;=  #{startTime}
            </if>
    		<if test="endTime != null and  endTime != ''">
                AND hsh_vend_reward.acquireDate    &lt;=  #{endTime}
            </if>
            <if test="schemeNo != null and  schemeNo != ''">
                AND hsh_vend_reward.schemeNo = #{schemeNo}
            </if>
            <if test="usrChannel != null and  usrChannel != ''">
                AND hsh_vend_reward.channel = #{usrChannel}
            </if>
             <if test="status != null and  status != ''">
                AND hsh_vend_reward.status = #{status}
            </if>
             <if test="vendcode != null and  vendcode != ''">
                AND hsh_vend_qr_code.vendcode = #{vendcode}
            </if>
            <if test="drawCode != null and  drawCode != ''">
                AND hsh_vend_reward.drawCode = #{drawCode}
            </if>
            <if test="idList != null and  idList != ''">
                AND hsh_vend_reward.id    in  (${idList})
            </if>
        </where>
		ORDER BY  hsh_vend_reward.createDate desc
	</select>
	
	
	
		<update id="getUpdateActivityManagement" >
	       UPDATE `hsh_activity_scheme`
			<set>
			
				<if test="schemeName !=null and schemeName !=''">
					schemeName = #{schemeName},
				</if>
				updateTime = now()
			</set>
			WHERE schemeNo = #{schemeNo}	
	       
	    </update>
	    
	    	<select id="getChannel" resultType="com.huilian.hlej.hcf.vo.ActivityManageVo" parameterType="com.huilian.hlej.hcf.vo.ActivityManageVo">
	        SELECT
				hsh_activity_scheme.*
			FROM
				hsh_activity_scheme
			where 1=1	
			<if test="schemeNo != null and  schemeNo != ''">
                AND hsh_activity_scheme.schemeNo  =  #{schemeNo}
            </if>
            <if test="schemeName != null and  schemeName != ''">
                AND hsh_activity_scheme.schemename  =  #{schemeName}
            </if>
           
    </select>
      <insert id="saveChannel" useGeneratedKeys="true" keyProperty="id">
  	 INSERT INTO `hsh_activity_scheme`(
	 		  `schemeNo` ,
			  `schemeName`,
			  `channel`,
			  `minPrice`,
			  `maxPrice`,
			  `activityType`,
			  `url`,
			  `template_id`,
			  `createTime`
		)
		VALUES
			(
				#{schemeNo},
				#{schemeName},
				#{channel},
				#{minPrice},
				#{maxPrice},
				#{activityType},
				#{url},
				#{templateId},
				now()
			);
 </insert>
 
  <insert id="saveReward" useGeneratedKeys="true" keyProperty="id">
  	 INSERT INTO `hsh_vend_reward`(
	 		  `schemeNo`
		
		)
		VALUES
			(
				#{schemeNo}
				
			);
</insert>
	
	
	<select id="getChannelById" resultType="com.huilian.hlej.hcf.vo.ActivityManageVo" parameterType="com.huilian.hlej.hcf.vo.ActivityManageVo">
	        SELECT
				hsh_activity_scheme.*
			FROM
				hsh_activity_scheme
			WHERE id = #{id}
    </select>
    
      <update id="updatePriceById" parameterType="com.huilian.hlej.hcf.vo.ActivityManageVo" >
       UPDATE `hsh_activity_scheme`
		<set>
			<if test="schemeNo !=null and schemeNo !=''">
				schemeNo = #{schemeNo},
			</if>
			<if test="schemeName !=null and schemeName !=''">
				schemeName = #{schemeName},
			</if>
			<if test="minPrice !=null and minPrice !=''">
				minPrice = #{minPrice},
			</if>
			<if test="maxPrice !=null and maxPrice !=''">
				maxPrice = #{maxPrice},
			</if>
			
				channel = #{channel},
				url = #{url},
			
			
				activityType = #{activityType},
		
				activity_id = #{activityId},
		
			updateTime = now()
		</set>
		WHERE id = #{id}	
    </update>
	
	<update id="deleteActivity" parameterType="com.huilian.hlej.hcf.vo.ActivityConterTemplateVo" >
	       DELETE  from  `hcf_activity_template`
	       
			WHERE template_id = #{templateId}
	       
    </update>
    
	<update id="deleteActivityById" parameterType="com.huilian.hlej.hcf.vo.ActivityManageVo" >
	       DELETE  from  `hsh_activity_scheme`
	       
			WHERE id = #{id}
	       
    </update>
    
	<!-- <update id="deleteMachine" parameterType="com.huilian.hlej.hcf.vo.VendingMachineVo" >
	       DELETE  from  `hsh_vend_qr_code`
			WHERE id = #{id} 
	       
    </update> -->
    
     <update id="deleteMachine" parameterType="com.huilian.hlej.hcf.vo.VendingMachineVo" >
       UPDATE `hsh_vend_qr_code`
		<set>
				optionType = #{optionType},
				template_id = #{templateId},
				oldTemplate_id = #{oldTemplateId},
		
			updateTime = now()
		</set>
		WHERE id = #{id}	
    </update>
    
    
    	<!-- 查询,主键查询   -->
	<select id="getSelectImg"  resultType="com.huilian.hlej.hcf.vo.ActivityTypeVo"  >
		SELECT
			vm.*
		FROM
			hcf_activity_type vm    where 1=1  and activityType=#{0}
	</select>
	
	
    	<!-- 查询,主键查询   -->
	<select id="getActivityManageBySchName"  resultType="com.huilian.hlej.hcf.vo.ActivityManageVo"  >
		SELECT
			vm.*
		FROM
			hsh_activity_scheme vm    where 1=1  and schemeNo=#{0}
	</select>
	
    	<!-- 查询,主键查询   -->
	<select id="getActivityManageBySchNameNo"  resultType="com.huilian.hlej.hcf.vo.ActivityManageVo"  >
		SELECT
			vm.*
		FROM
			hsh_activity_scheme vm    where 1=1  and schemeName=#{0}
	</select>
    	<!-- 查询,主键查询   -->
	<select id="getActivityManageBy"  resultType="com.huilian.hlej.hcf.vo.ActivityConterTemplateVo"  >
		SELECT
			vm.*
		FROM
			hcf_activity_template vm    where 1=1  and schemeNo=#{0}
	</select>
	
	
</mapper>   
