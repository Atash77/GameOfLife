<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
         符号转义说明
    &lt;          < 	
    &gt;          >  
    &lt;&gt;     <>
    &amp;        & 
    &apos;       '
    &quot;       "
  <![CDATA[ 这里写你的SQL或者符号 ]]> 
 -->
<mapper namespace="com.huilian.hlej.hcf.dao.DealerManagermentDao" > 

	<insert id="saveDealerManagermentVo" useGeneratedKeys="true" keyProperty="id">
		<![CDATA[
			INSERT INTO `hcf_dealer_baseInfo` (
			  `loginName` ,
			  `password` ,
			  `dealerType` ,
			  `dealerGrade` ,
			  `followStatus`,
			  `conStatus` ,
			  `cellPhone` ,
			  `detailAddress` ,
			  `createTime` ,
			  `idCard` ,
			  `bankCarInfo` ,
			  `bankCarNumber` ,
			  `dealerArea`,
			  `birthday` ,
			  `gender` ,
			  `dealerName` ,
			  `mailbox` ,
			  `parentId`,
			  `dealerID`,
			  `zxjy`,
			  `xyCode`,
			  `zxcxjgUrl`,
			  `zjzpUrl`,
			  `companyName`,
			  `zxjgFileName`,
			  `zjzpFileName`,
			  `bankCode`
			)
			VALUES
				(
					#{loginName},
					#{password},
					#{dealerType},
					#{dealerGrade},
					#{followStatus},
					#{conStatus},
					#{cellPhone},
					#{detailAddress},
					now(),
					#{idCard},
					#{bankCarInfo},
					#{bankCarNumber},
					#{dealerArea},
					#{birthday},
					#{gender},
					#{dealerName},
					#{mailbox},
					#{parentId},
					#{dealerID},
					#{zxjy},
					#{xyCode},
					#{zxcxjgUrl},
					#{zjzpUrl},
					#{companyName},
					#{zxjgFileName},
					#{zjzpFileName},
					#{bankCode}
				)
			]]> 
	</insert>
	
	<insert id="saveEquimentAndDealerId" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
		<selectKey resultType ="java.lang.Integer" keyProperty= "id"
                   order= "AFTER">
                 SELECT LAST_INSERT_ID()
        </selectKey >
		<![CDATA[
			INSERT INTO `hcf_vend_dealer` (
			  `loginName` ,
			  `vendCode` ,
			  `bangdingTime` ,
			  `location`
			)
			VALUES
		]]> 
		<foreach collection="list" item="item" index="index" separator=",">
			(
				#{item.loginName},
				#{item.vendCode},
				now(),
				#{item.location}
			)
		</foreach>
	</insert>
	
	<resultMap id="dealerManagermentVoMap" type="com.huilian.hlej.hcf.vo.DealerManagermentVo">
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<result column="dealerName" property="dealerName" jdbcType="VARCHAR"/>
		<result column="loginName" property="loginName" jdbcType="VARCHAR"/>
		<result column="dealerType" property="dealerType" jdbcType="VARCHAR"/>
		<result column="dealerGrade" property="dealerGrade" jdbcType="VARCHAR"/>
		<result column="followStatus" property="followStatus" jdbcType="VARCHAR"/>
		<result column="conStatus" property="conStatus" jdbcType="VARCHAR"/>
		<result column="cellPhone" property="cellPhone" jdbcType="VARCHAR"/>
		<result column="detailAddress" property="detailAddress" jdbcType="VARCHAR"/>
		<result column="lastLoginTime" property="lastLoginTime" jdbcType="VARCHAR"/>
		<result column="createTime" property="createTime" jdbcType="VARCHAR"/>
		<result column="idCard" property="idCard" jdbcType="VARCHAR"/>
		<result column="bankCarInfo" property="bankCarInfo" jdbcType="VARCHAR"/>
		<result column="dealerArea" property="dealerArea" jdbcType="VARCHAR"/>
		<result column="birthday" property="birthday" jdbcType="DATE"/>
		<result column="gender" property="gender" jdbcType="VARCHAR"/>
		<result column="mailbox" property="mailbox" jdbcType="VARCHAR"/>
		<result column="parentId" property="parentId" jdbcType="VARCHAR"/>
		<result column="bankCarNumber" property="bankCarNumber" jdbcType="VARCHAR"/>
	</resultMap>

	<select id="findDealerManagermentVoList" resultMap="dealerManagermentVoMap"
		parameterType="com.huilian.hlej.hcf.vo.DealerManagermentVo">
		SELECT
			id,
			dealerName,
			loginName,
			dealerType,
			dealerGrade,
			followStatus,
			conStatus,
			cellPhone,
			detailAddress,
			lastLoginTime,
			createTime,
			idCard,
			bankCarInfo,
			dealerArea,
			birthday,
			gender,
			mailbox,
			parentId,
			bankCarNumber,
			companyName,
			zxjy,
			xyCode,
			zxcxjgUrl,
			zjzpUrl,
			zxjgFileName,
			zjzpFileName,
			bankCode
		FROM
			hcf_dealer_baseInfo
		where 1=1
		<if test="loginName != null and  loginName != ''">
			AND hcf_dealer_baseInfo.loginName like CONCAT('%','${loginName}','%' )
		</if>
		<if test="dealerName != null and  dealerName != ''">
			AND hcf_dealer_baseInfo.dealerName like CONCAT('%','${dealerName}','%' )
		</if>
		<if test="cellPhone != null and  cellPhone != ''">
			AND hcf_dealer_baseInfo.cellPhone like CONCAT('%','${cellPhone}','%' )
		</if>
		
		<if test="dealerType != null and  dealerType != ''">
			AND hcf_dealer_baseInfo.dealerType = ${dealerType}
		</if>
		<if test="dealerGrade != null and  dealerGrade != ''">
			AND hcf_dealer_baseInfo.dealerGrade = ${dealerGrade}
		</if>
		<if test="conStatus != null and  conStatus != ''">
			AND hcf_dealer_baseInfo.conStatus = ${conStatus}
		</if>
		<if test="searchText != null and  searchText != ''">
			AND
			(hcf_dealer_baseInfo.loginName like CONCAT('%','${searchText}','%' ) OR hcf_dealer_baseInfo.dealerName like CONCAT('%','${searchText}','%' ) OR hcf_dealer_baseInfo.cellPhone = #{searchText})
		</if>
		ORDER BY hcf_dealer_baseInfo.createTime DESC  
	</select>
	
	<!-- 查询,主键查询   -->
	<select id="getDealerManagermentVo" parameterType="java.lang.String"  resultType="com.huilian.hlej.hcf.vo.DealerManagermentVo"  >
		SELECT
			*
		FROM
			hcf_dealer_baseInfo where 1=1  and loginName=#{loginName}
	</select>	
	
	<update id="updateDealerManagermentVo" parameterType="com.huilian.hlej.hcf.vo.DealerManagermentVo">
		UPDATE `hcf_dealer_baseInfo`
		<set>
			<if test="dealerName!=null and dealerName!=''">
				dealerName = #{dealerName},
			</if>
			<if test="loginName!=null and loginName!=''">
				loginName = #{loginName},
			</if>
			
			<if test="dealerType!=null and dealerType!=''">
				dealerType = #{dealerType},
			</if>
			<if test="conStatus!=null and conStatus!=''">
				conStatus = #{conStatus},
			</if>
			<if test="cellPhone!=null and cellPhone!=''">
				cellPhone = #{cellPhone},
			</if>
			<if test="detailAddress!=null and detailAddress!=''">
				detailAddress = #{detailAddress},
			</if>
			<if test="cellPhone!=null and cellPhone!=''">
				cellPhone = #{cellPhone},
			</if>
			<if test="idCard!=null and idCard!=''">
				idCard = #{idCard},
			</if>
			<if test="dealerArea!=null and dealerArea!=''">
				dealerArea = #{dealerArea},
			</if>
			<if test="bankCarInfo!=null and bankCarInfo!=''">
				bankCarInfo = #{bankCarInfo},
			</if>
			<if test="gender!=null and gender!=''">
				gender = #{gender},
			</if>
			<if test="mailbox!=null and mailbox!=''">
				mailbox = #{mailbox},
			</if>
			<if test="bankCarNumber!=null and bankCarNumber!=''">
				bankCarNumber = #{bankCarNumber},
			</if>
			<if test="dealerGrade!=null and dealerGrade!=''">
				dealerGrade = #{dealerGrade},
			</if>
			<if test="dealerID!=null and dealerID!=''">
				dealerID = #{dealerID},
			</if>
			<if test="password!=null and password!=''">
				password = #{password},
			</if>
			<if test="parentId!=null and parentId!=''">
				parentId = #{parentId},
			</if>
			<if test="companyName!=null and companyName!=''">
				companyName = #{companyName},
			</if>
			<if test="zxjy!=null and zxjy!=''">
				zxjy = #{zxjy},
			</if>
			<if test="xyCode!=null and zxjy!=''">
				xyCode = #{xyCode},
			</if>
			<if test="bankCode!=null and bankCode!=''">
				bankCode = #{bankCode},
			</if>
				zxcxjgUrl = #{zxcxjgUrl},
				zjzpUrl = #{zjzpUrl},
				zxjgFileName = #{zxjgFileName},
				zjzpFileName = #{zjzpFileName}
		</set>
		<where>
				id = ${id}
		</where>
				
	</update>
	
	<resultMap id="dealerDealerEqRelationVoMap" type="com.huilian.hlej.hcf.vo.DealerEqRelationVo">
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<result column="loginName" property="loginName" jdbcType="VARCHAR"/>
		<result column="vendCode" property="vendCode" jdbcType="VARCHAR"/>
		<result column="location" property="location" jdbcType="VARCHAR"/>
	</resultMap>
	
	<select id="getDealerEqRelationVoList" resultMap="dealerDealerEqRelationVoMap"
		parameterType="java.lang.String">
		<![CDATA[
			select id,loginName,vendCode,location from hcf_vend_dealer where loginName = #{loginName}
		]]>	
	</select>
	
	<resultMap id="dealerDealerEqRelationVoMap2" type="com.huilian.hlej.hcf.vo.DealerEqRelationVo">
		<result column="vendCode" property="vendCode" jdbcType="VARCHAR"/>
		<result column="location" property="location" jdbcType="VARCHAR"/>
	</resultMap>
	
	<select id="getDealerEqRelationVoAll" resultMap="dealerDealerEqRelationVoMap2">
		<![CDATA[
			SELECT
			vendCode,
			CONCAT(
				provinceName,
				cityName,
				areaName,
				deliveryType,
				location
			) AS location
		FROM
			hsh_vend_qr_code
		]]>	
		<where>
			location &lt;&gt; ''
		</where>
	</select>
	
	<select id="queryDealerManagermentVoByLoginName" parameterType="java.lang.String" resultType="java.lang.Integer">
		<![CDATA[
			SELECT count(1) from hcf_dealer_baseInfo where loginName = #{loginName}
		]]>
	</select>
	
	<update id="updateDealerEqRelationVo" parameterType="com.huilian.hlej.hcf.vo.DealerEqRelationVo">
		<![CDATA[
			UPDATE  hcf_vend_dealer set vendCode = #{vendCode},location=#{location} where id=#{id}
		]]>
	</update>
	
	<delete id="deleteDealerEqRelationVo" parameterType="java.lang.String">
		<![CDATA[
			DELETE from hcf_vend_dealer where id=#{id}
		]]>
	</delete>
	
	<select id="isRepeat" parameterType="com.huilian.hlej.hcf.vo.DealerEqRelationVo" resultType="java.lang.Integer">
		<![CDATA[
			SELECT COUNT(1) FROM hcf_vend_dealer t WHERE t.vendCode = #{vendCode}
		]]>
	</select>
	
	<resultMap id="superiorAgentMap" type="com.huilian.hlej.hcf.vo.DealerManagermentVo">
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<result column="dealerName" property="dealerName" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 查询上级代理 列表-->
	<select id="superiorAgentList" parameterType="java.lang.Integer" resultMap="superiorAgentMap">
		<![CDATA[
			select id,dealerName from hcf_dealer_baseInfo
		]]>
	</select>

	<!-- 查询某个代理级别的代理商 -->
	<select id="superiorAgentListByGrade" parameterType="java.util.Map" resultType="java.util.Map">
		<![CDATA[
			select id,dealerName from hcf_dealer_baseInfo where dealerGrade = ${dealerGrade} - 1
		]]>
	</select>
	
	<select id="getdealerNameById" parameterType="java.util.Map" resultType="java.lang.String">
		<![CDATA[
			select dealerName from hcf_dealer_baseInfo where id = ${id}
		]]>
	</select>
	
	<!-- 保存代理商类型为公司时  征信查询结果上传文件路径  和证件照片路径到临时表中 -->
	<insert id="saveFileOrImage" useGeneratedKeys="true" keyProperty="id" parameterType="java.util.Map">
		<![CDATA[
			insert into hcf_dealer_fileTemp(filePath,type,fileName,loginName) values(#{filePath},${type},#{fileName},#{loginName})
		]]>
	</insert>
	<!-- 获取临时表里的  证件查询结果 文件url -->
	<select id="getFileUrl" parameterType="java.util.Map" resultType="java.lang.String">
		<![CDATA[
			select GROUP_CONCAT(filePath) as filePath from hcf_dealer_fileTemp where type = ${type} and loginName=#{loginName}
		]]>
	</select>
	<!-- 清空临时表 -->
	<delete id="deleteTempData">
		<![CDATA[
			TRUNCATE hcf_dealer_fileTemp
		]]>
	</delete>
	<!-- 删除临时表对应的url -->
	<delete id="deleteFilePath" parameterType="java.lang.String">
		<![CDATA[
			delete from hcf_dealer_fileTemp where filePath=#{filePath}
		]]>
	</delete>
	<!-- 获取临时表里的  文件原名 -->
	<select id="getFileName" parameterType="java.util.Map" resultType="java.lang.String">
		<![CDATA[
			select GROUP_CONCAT(fileName) as fileName from hcf_dealer_fileTemp where type = ${type} and loginName=#{loginName}
		]]>
	</select>
	
	<resultMap id="divideAccountVoMaps" type="com.huilian.hlej.hcf.vo.DivideAccountVo">
		<result column="id" property="id" jdbcType="VARCHAR"/>
		<result column="templateName" property="templateName" jdbcType="VARCHAR"/>
		<result column="settlementWay" property="settlementWay" jdbcType="NUMERIC"/>
		<result column="createTime" property="createTime" jdbcType="TIMESTAMP"/>
		<result column="updateTime" property="updateTime" jdbcType="TIMESTAMP"/>
		<result column="operator" property="operator" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 查询模版列表  -->
	<select id="getDivideAccountVoList" resultMap="divideAccountVoMaps" parameterType="com.huilian.hlej.hcf.vo.DivideAccountVo">
		<![CDATA[
			SELECT
				t.id,
			  	t.templateName,
				t.settlementWay,
				t.createTime,
				t.updateTime,
				t.operator
			FROM
				hcf_dealer_divide_account_template t
				where 1=1
		]]>
	</select>
	
	<!-- 保存绑定模版与代理商对应关系 -->
	<insert id="saveBandDingInfo" parameterType="com.huilian.hlej.hcf.vo.DealerTemplateVo">
		<![CDATA[
			INSERT INTO hcf_dealer_template (
				loginName,
				templateId,
				useTime,
				dealerName,
				dealerType,
				operator
			)
			VALUES
				(
				  #{loginName},
				  #{templateId},
				  now(),
				  #{dealerName},
				  #{dealerType},
				  #{operator}
				)
		]]>
	</insert>
	
	<resultMap id="dealerTemplateMap" type="com.huilian.hlej.hcf.vo.DealerTemplateVo">
		<result column="templateId" property="templateId" jdbcType="VARCHAR"/>
		<result column="templateName" property="templateName" jdbcType="VARCHAR"/>
		<result column="useTime" property="useTimeStr" jdbcType="VARCHAR"/>
		<result column="operator" property="operator" jdbcType="VARCHAR"/>
	</resultMap>
	
	<!-- 查询分帐设置模版列表  -->
	<select id="getDealerTemplateList" parameterType="java.lang.String" resultMap="dealerTemplateMap">
		<![CDATA[
			SELECT
				t1.templateId,
				t2.templateName,
				DATE_FORMAT(t1.useTime,'%Y-%m-%d %H:%m:%s') as useTime,
				t1.operator
			FROM
				hcf_dealer_template t1
			LEFT JOIN hcf_dealer_divide_account_template t2 ON (t1.templateId = t2.id)
			WHERE
			loginName = #{loginName} order by t1.useTime desc
		]]>
	</select>
</mapper>   
